<app-header></app-header>

<div class="form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        {{ isEditMode() ? 'Edit Product' : 'Add New Product' }}
      </mat-card-title>
      <mat-card-subtitle>
        {{ isEditMode() ? 'Update product information' : 'Fill in the product details below' }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      @if (loading() && isEditMode()) {
        <div class="loading-state">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading product...</p>
        </div>
      } @else {
        <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
          <!-- Product Name -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Product Name</mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Enter product name"
              maxlength="255"
            />
            <mat-icon matPrefix>inventory_2</mat-icon>
            <mat-hint align="end">{{ productForm.get('name')?.value?.length || 0 }}/255</mat-hint>
            @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
              <mat-error>{{ getErrorMessage('name') }}</mat-error>
            }
          </mat-form-field>

          <!-- Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Enter product description"
              rows="4"
              maxlength="1000"
            ></textarea>
            <mat-icon matPrefix>description</mat-icon>
            <mat-hint align="end">{{ productForm.get('description')?.value?.length || 0 }}/1000</mat-hint>
            @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
              <mat-error>{{ getErrorMessage('description') }}</mat-error>
            }
          </mat-form-field>

          <!-- Image URL -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Image URL</mat-label>
            <input
              matInput
              formControlName="image"
              placeholder="Enter image URL (optional)"
              maxlength="500"
              (input)="onImageUrlChange()"
            />
            <mat-icon matPrefix>image</mat-icon>
            <mat-hint>Enter a valid image URL (e.g., https://example.com/image.jpg)</mat-hint>
            @if (productForm.get('image')?.invalid && productForm.get('image')?.touched) {
              <mat-error>{{ getErrorMessage('image') }}</mat-error>
            }
          </mat-form-field>

          <!-- Image Preview -->
          @if (imagePreviewUrl()) {
            <div class="image-preview-container">
              <div class="image-preview">
                <img 
                  [src]="imagePreviewUrl()" 
                  [alt]="'Preview of ' + (productForm.get('name')?.value || 'product')"
                  (error)="onPreviewImageError($event)"
                  loading="lazy"
                />
                @if (imagePreviewError()) {
                  <div class="preview-error">
                    <mat-icon>error_outline</mat-icon>
                    <span>Invalid image URL</span>
                  </div>
                }
              </div>
              <button 
                mat-button 
                type="button" 
                color="warn" 
                (click)="clearImagePreview()"
                class="clear-preview-btn"
              >
                <mat-icon>close</mat-icon>
                Clear Preview
              </button>
            </div>
          }

          <!-- Price and Status Row -->
          <div class="form-row">
            <!-- Price -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Price</mat-label>
              <input
                matInput
                type="number"
                formControlName="price"
                placeholder="99.99"
                step="0.01"
                min="0"
              />
              <span matPrefix>$&nbsp;</span>
              <mat-hint>Enter price in USD</mat-hint>
              @if (productForm.get('price')?.invalid && productForm.get('price')?.touched) {
                <mat-error>{{ getErrorMessage('price') }}</mat-error>
              }
            </mat-form-field>

            <!-- Status -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                @for (option of statusOptions; track option.value) {
                  <mat-option [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                }
              </mat-select>
              @if (productForm.get('status')?.invalid && productForm.get('status')?.touched) {
                <mat-error>{{ getErrorMessage('status') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <div class="form-actions-left">
              <button
                mat-raised-button
                type="button"
                (click)="cancel()"
                [disabled]="loading()"
              >
                <mat-icon>cancel</mat-icon>
                Cancel
              </button>
              
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="loading()"
                class="submit-button"
              >
                @if (loading()) {
                  <mat-spinner diameter="20"></mat-spinner>
                  <span>{{ isEditMode() ? 'Updating...' : 'Creating...' }}</span>
                } @else {
                  <ng-container>
                    <mat-icon>{{ isEditMode() ? 'save' : 'add' }}</mat-icon>
                    <span>{{ isEditMode() ? 'Update Product' : 'Create Product' }}</span>
                  </ng-container>
                }
              </button>
            </div>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>

